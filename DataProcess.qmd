---
title: "Data Processing"
author: "Jieyuan Yan, Puwen Wen"
format: html
---
```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

## Prepare environment
```{r}
library(here)
library(vroom)
library(tidyr)
library(dplyr)
library(eurostat)
library(ggplot2)
```

## Read Dataset
```{r}
urb_cpopcb <- suppressMessages(get_eurostat('urb_cpopcb', time_format = "num", stringsAsFactors = TRUE))
ilc_di16 <- suppressMessages(get_eurostat('ilc_di16', time_format = "num", stringAsFactors = TRUE))
ilc_iw16 <- suppressMessages(get_eurostat('ilc_iw16', time_format = "num", stringAsFactors = TRUE))
ilc_peps06 <- suppressMessages(get_eurostat('ilc_peps06', time_format = "num", stringAsFactors = TRUE))
ilc_lvps16 <- suppressMessages(get_eurostat('ilc_lvps16', time_format = "num", stringAsFactors = TRUE))
edat_lfs_9912 <- suppressMessages(get_eurostat('edat_lfs_9912', time_format = "num", stringAsFactors = TRUE))
lfsa_pfgacedm <- suppressMessages(get_eurostat('lfsa_pfgacedm', time_format = "num", stringAsFactors = TRUE))
lfst_r_eredcobu <- suppressMessages(get_eurostat('lfst_r_eredcobu', time_format = "num", stringAsFactors = TRUE))
edat_lfs_9915 <- suppressMessages(get_eurostat('edat_lfs_9915', time_format = "num", stringAsFactors = TRUE))
migr_imm8 <- suppressMessages(get_eurostat('migr_imm8', time_format = "num", stringAsFactors = TRUE))
demo_pjangroup <- suppressMessages(get_eurostat('demo_pjangroup', time_format = "num", stringAsFactors = TRUE))
ilc_di03 <- suppressMessages(get_eurostat('ilc_di03', time_format = "num", stringAsFactors = TRUE))
```

`countries` is vector of all fields of EU contries.

`birth_eu` is vector of all fields of foreigners born in eu, given EU is changing overtime, we collect them together.

`birth_neu` is vector of all fields of foreigners born in non-eu, given EU is changing overtime, we collect them together. For example, we regard `EU28_FOR`, `EU27_2007_FOR`, and `EU27_2020_FOR` as foreigner born in Europe.

```{r}
countries = c("BE","BG","CZ","DK","DE","EE","IE","EL","ES","FR","IT","CY","LV","LT","LU","HU","MT","NL","AT","PL","PT","RO","SI","SK","FI","SE","NO","CH","UK")
birth_eu = c("EU28_FOR","EU27_2007_FOR","EU27_2020_FOR")
birth_neu = c("NEU27_2007_FOR","NEU27_2020_FOR","NEU28_FOR")
```


=======
## Describe the original data file

Notice: All the fields used in data files could be found in `DataDescription.qmd`

### urb_cpopcb


Title: Population by citizenship and country of birth - cities and greater cities.

Link: https://ec.europa.eu/eurostat/databrowser/view/urb_cpopcb/default/table?lang=en&category=mi.mii.mii_urb

Description: Contains population data classified by citizenship and country of birth for urban and metropolitan areas, enabling demographic and migration trend analyses.

Fields: freq, indic_ur, cities

Ranges: 1990-2024

### ilc_di16

Title: Mean and median income by group of country of birth (population aged 18 and over).

Link: https://ec.europa.eu/eurostat/databrowser/view/ilc_di16/default/table?lang=en&category=mi.mii.mii_soinc.mii_ip

Description: Similar to ilc_di15 but focuses on grouping by country of birth, highlighting income disparities among native-born and foreign-born populations.

Fields: freq,unit,indic_il,c_birth,sex,age,geo

Ranges: 2003-2023


### ilc_iw16

Link: https://ec.europa.eu/eurostat/databrowser/view/ilc_iw16/default/table?lang=en&category=mi.mii.mii_soinc.mii_ip

Title: In-work at-risk-of-poverty rate by group of country of birth(population aged 18 and over).

Description: Captures poverty rates among employed individuals, broken down by country of birth groups.

Fields: freq,unit,c_birth,sex,age,geo
  
Ranges: 2003-2023

### ilc_peps06n:

Link: https://ec.europa.eu/eurostat/databrowser/view/ilc_peps06/default/table?lang=en&category=mi.mii.mii_soinc.mii_pe

Title: Persons at risk of poverty or social exclusion by group of country of birth (population aged 18 and over).

Fields: freq,c_birth,sex,age,unit,geo

Ranges: 2003-2020


### ilc_lvps16:

Link: https://ec.europa.eu/eurostat/databrowser/view/ilc_lvps16/default/table?lang=en&category=mi.mii.mii_soinc.mii_lc

Title: Distribution of population by group of country of birth and tenure status (population aged 18 and over).

Description: Reports housing tenure types (e.g., owned or rented) across groups defined by country of birth.

Fields: freq,unit,tenure,c_birth,sex,age,geo

Ranges: 2003-2024


### edat_lfs_9912:


Link: https://ec.europa.eu/eurostat/databrowser/view/edat_lfs_9912/default/table?lang=en&category=mi.mii.mii_educ.mii_edata

Title: Population by educational attainment level, sex, age, and country of birth (%).

Description: Shows educational attainment levels across demographic and migration status categories.

Fields: freq,unit,sex,isced11,c_birth,age,geo

Ranges: 2004-2023


### lfst_r_lfur2gacu

Link: https://ec.europa.eu/eurostat/databrowser/view/lfst_r_lfur2gacu/default/table?lang=en&category=mi.mii.mii_emp_r.mii_une_r

Title: Unemployment rates by sex, age, country of birth and degree of urbanisation

Fields: freq,unit,deg_urb,c_birth,sex,age,geo

Ranges: 1995-2023


### lfst_r_eredcobu

Link: https://ec.europa.eu/eurostat/databrowser/view/lfst_r_eredcobu/default/table?lang=en&category=mi.mii.mii_emp_r.mii_em_r

Title: Employment rates by sex, age, educational attainment level, country of birth and degree of urbanisation

Fields: freq,deg_urb,c_birth,isced11,age,sex,unit,geo

Ranges: 1995-2023

### ilc_di03

Link: https://ec.europa.eu/eurostat/databrowser/view/ilc_di03$defaultview/default/table?lang=en

Title: Mean and median income by age and sex

Fields: freq,unit,indic_il,c_birth,sex,age,geo

Ranges: 1995-2023


### demo_pjangroup

Link: https://ec.europa.eu/eurostat/databrowser/view/demo_pjangroup$defaultview/default/table?lang=en

Title: Population on 1 January by age group and sex

Fields: age,geo,sex,time,freq,unit

Ranges: 1960-2023


### migr_imm8

Link: https://ec.europa.eu/eurostat/databrowser/view/migr_imm8$defaultview/default/table?lang=en

Title: Immigration by age and sex

Fields: age,geo,sex,time,freq,unit

Ranges: 1990-2022


## Summary

### Overall summary

Raw data files before processing have different keys and measurement, so in overall summary we only present the column numbers and row numbers of each dataset. More detailed description for each data file is in the next subsection.


```{r}


# Organize data frames into a named list
data_list <- list(
  urb_cpopcb=urb_cpopcb,
  ilc_di16=ilc_di16,
  ilc_iw16=ilc_iw16,
  ilc_peps06=ilc_peps06,
  ilc_lvps16=ilc_lvps16,
  edat_lfs_9912=edat_lfs_9912,
  lfsa_pfgacedm=lfsa_pfgacedm,
  demo_pjangroup=demo_pjangroup,
  lfst_r_eredcobu=lfst_r_eredcobu,
  migr_imm8=migr_imm8
)

# Create the summary table
summary_table <- bind_rows(
  lapply(names(data_list), function(name) {
    data <- data_list[[name]]
    tibble(
      Data_Frame = name,
      Rows = nrow(data),
      Columns = ncol(data)
    )
  })
)

print(summary_table)


```

## Basic Statistic Description for each data file with graphical representation

### urb_cpopcb

Considering there are too many cities, we only consider country-level data, so we extract the country field in `cities`. For `indic_ur`(urban audit indicator), we extract rows of `DE2002V`(EU foreigners) and `DE2002V`(Non-EU foreigners), as these are two types of immigrants we desire to research. We extract our desired table and display some statistic characteristic as below.

```{r}
urb_cpopcb_filter = urb_cpopcb |>
  filter((indic_ur%in% c('DE2003V','DE2002V'))&(cities%in%countries))

summary_urb_cpopcb <-  urb_cpopcb_filter|> group_by(indic_ur,cities) |>
  summarise(rows = n())
```

After filtering, `urb_cpopcb` has `r nrow(urb_cpopcb_filter)` rows, and `r ncol(urb_cpopcb_filter)` columns.


We display the number of valid data for each EU country. The distribution is not even, with some country having just 1 or 2 data sample, such as PL(Poland).
```{r}

summary_urb_cpopcb |> ggplot(aes(x=cities,y=rows,fill=indic_ur))+geom_bar(stat = "identity")+
  facet_wrap(vars(indic_ur),nrow = 2, ncol = 1) + theme(text = element_text(size = 10))

```
We display the immigrant trend for different countries. For simplicity, we choose some representative countries(based on the available sample), and show the number of immigrants across the sample years. The chosen countries are: BE(Belgium), FR(France), DE(Germany), SE(Sweden), NL(Netherlands), IT(Italy), FI(Finland), PT(Portugal), ES(Spain).

```{r}

urb_cpopcb_filter |> filter(cities%in%c("BE","FR","DE","SE","NL","IT","FI","PT","ES")) |>
  ggplot(aes(TIME_PERIOD,values, color=indic_ur)) + geom_line() + 
  facet_wrap(~ cities, nrow = 3, ncol = 3, scales = "free")

```


### ilc_di16

It is table of Mean and median income by group of country of birth.
Similarly, we extract our desired fields. For countries, (Note that now it's in `geo` column), we do it as above. For unit of measure, we adopt the `PPS`(Purchasing power standard), which is a more reasonable indicator compared with Euro (getting rid of money supply, inflation, etc.). For `indic_il`(income and living condition indicators), we choose `MEI_E`(Mean equivalised net income).

For the `c_birth`, as we illustrate before, the member of EU is changing, so we need to harmonise the calibre of statistics. We assign `EU_FOR` and `NEU_FOR` for both two categories.

```{r}
ilc_di16_filter = ilc_di16 |> 
  filter(unit=='PPS',geo%in%countries,indic_il=='MEI_E') |> 
  mutate( c_birth = case_when(
    c_birth %in% birth_eu ~ "EU_FOR",
    c_birth %in% birth_neu ~ "NEU_FOR",
    TRUE ~ c_birth ))

summary_ilc_dil6 <- ilc_di16_filter|>
  group_by(geo,c_birth) |>
  summarise(rows = n())

```
After filtering, `ilc_di16_filter` has `r nrow(ilc_di16_filter)` rows, and `r ncol(ilc_di16_filter)` columns.

We display mean and median income of immigrants as below. Similarly, we only show some of the countries.
the figure is the average income group by countries, country of birth and sex


```{r}
ilc_di16_filter |> filter(geo%in%c("BE","FR","DE","SE","NL","IT","FI","PT","ES")) |>
  filter(age=='Y_GE18', c_birth%in%c("EU_FOR","NEU_FOR")) |>
  ggplot(aes(TIME_PERIOD,values, color=interaction(sex, c_birth))) + geom_line() + 
  facet_wrap(~ geo, nrow = 3, ncol = 3, scales = "free")
```
### ilc_di03

It's the table of Mean and median income by age and sex, which is used to compare the income level of immigrants with the overall level. We will use this table in the further analysis(regression).

We conduct the similar filter operation on the table.


```{r}
ilc_di03_filter = ilc_di03 |> filter(unit=='PPS',geo%in%countries,indic_il=='MEI_E')
```

After filtering, `ilc_di03_filter` has `r nrow(ilc_di03_filter)` rows, and `r ncol(ilc_di03_filter)` columns.

We display the trend of income level for different genders across country.
```{r}
ilc_di03_filter|>filter(age=="TOTAL") |>
  filter(geo%in%c("BE","FR","DE","SE","NL","IT","FI","PT","ES")) |>
  ggplot(aes(TIME_PERIOD,values, color=sex)) + geom_line() + 
  facet_wrap(~ geo, nrow = 3, ncol = 3, scales = "free")
```
```{r}
ilc_di03_filter|>filter(sex=="T")|>
  filter(geo%in%c("BE","FR","DE","SE","NL","IT","FI","PT","ES")) |>
  filter(age%in%c("Y16-24","Y25-49","Y50-64"))|>
  ggplot(aes(TIME_PERIOD,values, color=age)) + geom_line() + 
  facet_wrap(~ geo, nrow = 3, ncol = 3, scales = "free")
```



### ilc_iw16

It's the table of In-work at-risk-of-poverty rate by group of country of birth(population aged 18 and over). We conduct similar operation on this table (filter countries, assign new value to c_birth). 


```{r}
ilc_iw16_filter = ilc_iw16 |> 
  filter(geo%in%countries) |> 
  mutate( c_birth = case_when(
    c_birth %in% birth_eu ~ "EU_FOR",
    c_birth %in% birth_neu ~ "NEU_FOR",
    TRUE ~ c_birth ))

summary_ilc_iwl6 <- ilc_iw16_filter|>
  group_by(geo,c_birth) |>
  summarise(rows = n())

```
After filtering, `ilc_iw16_filter` has `r nrow(ilc_iw16_filter)` rows, and `r ncol(ilc_iw16_filter)` columns.

We display In-work at-risk-of-poverty rate as below.

```{r}
ilc_iw16_filter |> filter(age=='Y_GE18', sex=='T', c_birth!='NAT') |>  
  filter(geo%in%c("BE","FR","DE","SE","NL","IT","FI","PT","ES")) |>
  ggplot(aes(TIME_PERIOD,values, color=c_birth)) + geom_line() + 
  facet_wrap(~ geo, nrow = 3, ncol = 3, scales = "free")
```
```{r}
ilc_iw16_filter |> filter(age=='Y_GE18', c_birth=='FOR') |>  
  filter(geo%in%c("BE","FR","DE","SE","NL","IT","FI","PT","ES")) |>
  ggplot(aes(TIME_PERIOD,values, color=sex)) + geom_line() + 
  facet_wrap(~ geo, nrow = 3, ncol = 3, scales = "free")
```


### ilc_peps06

```{r}

ilc_peps06_filter <- ilc_peps06 |> 
  filter(geo%in%countries)

summary_ilc_peps06 <- ilc_peps06 |> 
  filter(geo%in%countries)|>
  group_by(geo,c_birth) |>
  summarise(rows = n())
print(summary_ilc_peps06)

```

After filtering, `ilc_peps06_filter` has `r nrow(ilc_peps06_filter)` rows, and `r ncol(ilc_peps06_filter)` columns.

### ilc_lvps16

```{r}
ilc_lvps16_filter = ilc_lvps16 |> 
  filter(geo%in%countries) |> 
  mutate( c_birth = case_when(
    c_birth %in% birth_eu ~ "EU_FOR",
    c_birth %in% birth_neu ~ "NEU_FOR",
    TRUE ~ c_birth ))

summary_ilc_lvps16 <- ilc_lvps16_filter |> 
  filter(geo%in%countries)|>
  group_by(geo,c_birth) |>
  summarise(rows = n())

```
After filtering, `ilc_lvps16_filter` has `r nrow(ilc_lvps16_filter)` rows, and `r ncol(ilc_lvps16_filter)` columns.

```{r}

ilc_lvps16_filter |> filter(age=="Y_GE18",sex=="T",c_birth%in%c('EU_FOR','NEU_FOR')) |>
  filter(geo%in%c("BE","FR","DE","SE","NL","IT","FI","PT","ES")) |> 
  ggplot(aes(TIME_PERIOD,values,color=interaction(tenure,c_birth)))+
  geom_line()+facet_wrap(~geo, nrow = 3, ncol = 3, scales = "free")


```
### edat_lfs_9912

It's table of Population by educational attainment level, sex, age, and country of birth (%).
```{r}
edat_lfs_9912_filter = edat_lfs_9912 |> filter(geo%in%countries) |> 
  mutate( c_birth = case_when(
    c_birth %in% birth_eu ~ "EU_FOR",
    c_birth %in% birth_neu ~ "NEU_FOR",
    TRUE ~ c_birth ))

summary_edat_lfs_9912 <- edat_lfs_9912_filter |> 
  filter(geo%in%countries)|>
  group_by(geo,c_birth) |>
  summarise(rows = n())
```
After filtering, `edat_lfs_9912_filter` has `r nrow(edat_lfs_9912_filter)` rows, and `r ncol(edat_lfs_9912_filter)` columns.


For simplicity, we display the education attainment level for immigrants (EU foreigner and NEU foreigner) of France.
```{r}

edat_lfs_9912_filter |> filter(geo=='FR',age=='Y18-64',sex=='T') |>
  filter(isced11%in%c('ED0-2','ED3_4','ED5-8'),c_birth%in%c('EU_FOR','NEU_FOR')) |>
  ggplot(aes(TIME_PERIOD,values,color=isced11))+geom_bar(stat='identity')+
  facet_wrap(~ c_birth)

```
### lfsa_pfgacedm

```{r}
lfsa_pfgacedm_filter <- lfsa_pfgacedm |>
  filter(geo%in%countries)

summary_lfsa_pfgacedm <- lfsa_pfgacedm |> 
  filter(geo%in%countries)|>
  group_by(geo,c_birth) |>
  summarise(rows = n())
print(summary_lfsa_pfgacedm)

```
After filtering, `lfsa_pfgacedm_filter` has `r nrow(lfsa_pfgacedm_filter)` rows, and `r ncol(lfsa_pfgacedm_filter)` columns.

### lfst_r_eredcobu

```{r}
lfst_r_eredcobu_filter <- lfst_r_eredcobu|>
  filter(geo%in%countries)

summary_lfst_r_eredcobu <- lfst_r_eredcobu |> 
  filter(geo%in%countries)|>
  group_by(geo,c_birth) |>
  summarise(rows = n())
print(summary_lfst_r_eredcobu)

```

After filtering, `lfst_r_eredcobu_filter` has `r nrow(lfst_r_eredcobu_filter)` rows, and `r ncol(lfst_r_eredcobu_filter)` columns.

### demo_pjangroup

```{r}
demo_pjangroup_filter <-  demo_pjangroup|>
  filter(geo%in%countries)

summary_demo_pjangroup <- demo_pjangroup |> 
  filter(geo%in%countries)|>
  group_by(geo) |>
  summarise(rows = n())
print(summary_demo_pjangroup)

```
After filtering, `demo_pjangroup_filter` has `r nrow(demo_pjangroup_filter)` rows, and `r ncol(demo_pjangroup_filter)` columns.


### migr_imm8

```{r}
migr_imm8_filter <- migr_imm8|>
   filter(geo%in%countries)

summary_migr_imm8 <- migr_imm8 |> 
  filter(geo%in%countries)|>
  group_by(geo) |>
  summarise(rows = n())
print(summary_migr_imm8)

```
After filtering, `migr_imm8_filter` has `r nrow(migr_imm8_filter)` rows, and `r ncol(migr_imm8_filter)` columns.

## Research Question

### Question 1
1. Does the scale of immigration influence the income of immigrants? To what extent does the immigration affect the economy of targeted countries?

With the first part of research, we can identify the concentration effect of immigrants on themselves. More precisely, whether the concentration of immigrants improve or decrease the welfare of immigrants.

In the first question, we take the immigrant scale (foreign-born population as a proportion in total population) as independent variable, and the median/average income(measured by purchasing power standard) of immigrants as dependent variable. To accurately identify the effect of immigration scale on immigrants' income, we keep the individual characteristics as constant(sex,age), and introduce some basic indicators of a country as controlled variables, including population, GDP, and inflation.

We also want to explore the immigration trend over time within a single country, which requires us to use time series data. Thus we collect the annual immigration data of each country, spanning between 2003 and 2023.

Simultaneity should be noticed so that we come to the second part of question. To what extent the immigration affect the economy of targeted countries? In this part we also conduct cross-national comparative analysis and time series for longitudinal impact. While this part has GDP as dependent variable and immigration scale as independent variable, and controlled variables keep the same.

Through this part of research, we can figure out the degree of significance of immigration for economic development of European countries.

The data panel used in two parts of this question is the same. 

To examine the validity of regression we implement Granger Causality Tests in the time series context, which test for the directional causality between immigration and economic changes.


### Question 2

2. What factors within immigrant group decide their income? Compared to the native population, what are differences of these effects? What can we conclude from these differences on the mechanism of immigration impact on the economy of targeted countries?

In this question, we study the key determinants of income of immigrant group, incorporating comparative analysis with natives and temporal dynamics of these determinants. For example, how do the effects of factors like education and urbanization on income level differ for immigrants versus the native population? Are there any difference for immigrants from EU countries and non-EU countries? Moreover, we can find from this question we can find how has the demographic structure of immigrants evolved during the last 20 years.

In this part, we take the employment rate as independent variable, using education/ages/sex/degree of urbanization/wage of the natives as regressors, and the immigration scale as a controlled variable. All these data are collected over time. 

Similar to the first question, we adopt Granger Causality Tests in the time series context, which test for the directional causality between immigration and economic changes.


## Introduce the variable

In this section we introduce some important variables.

### Panel A

`geo` indicates European country/region. Which country/region the abbreviations refer to can be consulted on Eurostat.

`c_birth` is a tag to distinguish foreigners born inside EU and those born outside EU, which allows us to separately study the interior flexibility of EU citizens and the population influx from outside EU.
`EU_FOR` represents those immigrants whose countries of birth are EU countries;
`NEU_FOR` represents those immigrants whose countries of birth are Non-EU countries.

`Mean_income` of foreigners is measured by purchasing power standard, instead of Euros.

High education ratio represents the proportion of population whose education level is `ED5-8`, which is a relatively high education level. 

`immigration_ratio` is calculated by `Immigration_num` and `Pop_num`. 

### Panel B



## Data Cleaning and Joining

Corresponding to two research questions, we design two data panels. In this part we clean and join the raw data file.

### PanelA

PanelA: first research question, consist of four 4 table

- tableA: mean income data, measured by Purchasing power standard, extracting all sex, all age, country of birth in EU or nonEU(considering the EU is changing overall, we use  `ifelse` to assign a fixed label), geo from EU countries.

- tableB: immigration number data, measured by number, extracting all sex, all age, complete age definition, geo from EU countries.

- tableC: education component data, measure by ratio(the ratio of the number of a specific education level immigrants to all imigrants). We extract all sex, all deg_urb, country of birth in EU or nonEU, geo from EU countries, and isced11 of ED5-8(Tertiary education). The main value is the ratio of Tertiary education immigrants to all immigrants in the same group.

- tableD: number of population, we extract geo and TIME_PERIOD level data.

Hence the Panel consists of several variables, geo, c_birth, TIME_PERIOD, Mean_income, Immigration_num, Highedu_ratio, Pop_num, and we compute a new variable `Imigration_ratio`, the ratio of Immigration to Total Population.


```{r}

A = ilc_di16 |> filter((sex=='T')&(age=='Y_GE18')&(c_birth%in%birth_neu | c_birth%in%birth_eu)&
    (indic_il=='MEI_E')&(unit=='PPS')&(geo%in%countries)) |> mutate(Mean_income_FOR=values) |>
    select(geo,c_birth,TIME_PERIOD,Mean_income_FOR)
A = A |> mutate( c_birth=ifelse(c_birth%in%birth_eu, "EU_FOR", 
             ifelse(c_birth%in%birth_neu, "NEU_FOR", "Other")))


B = migr_imm8|>filter((age=='TOTAL')&(sex=='T')&(agedef=='COMPLET')&(geo%in%countries)) |>
    mutate(Immigration_num=values) |> select(geo,TIME_PERIOD,Immigration_num)

C = edat_lfs_9915 |> filter((sex=="T")&(deg_urb=="TOTAL")&(geo%in%countries)&(isced11=="ED5-8")&
    (age=='Y15-64')&(c_birth%in%birth_neu | c_birth%in%birth_eu)) |> 
    mutate(Highedu_ratio=values)|>select(geo,c_birth,TIME_PERIOD,Highedu_ratio)
C = C |> mutate( c_birth=ifelse(c_birth%in%birth_eu, "EU_FOR", 
             ifelse(c_birth%in%birth_neu, "NEU_FOR", "Other")))

D = demo_pjangroup |> filter((sex=='T')&(age=='TOTAL')&(geo%in%countries))|>mutate(Pop_num=values)|>
  select(geo,TIME_PERIOD,Pop_num)

E = ilc_di03|> filter((sex=="T")&(age=="Y_GE18")&(geo%in%countries)&(unit=="PPS")&(indic_il=="MEI_E"))|>
  mutate(Mean_income_NAT = values)|>select(geo,TIME_PERIOD,Mean_income_NAT)


panelA = A |> inner_join(B, by = c("geo","TIME_PERIOD")) |> 
              inner_join(C, by = c("geo","TIME_PERIOD","c_birth")) |>
              inner_join(D, by = c("geo","TIME_PERIOD")) |>
              inner_join(E, by = c("geo","TIME_PERIOD"))
panelA = panelA |> select(geo,c_birth,TIME_PERIOD,Mean_income_FOR,Mean_income_NAT,Immigration_num,Highedu_ratio,Pop_num) |>
          mutate(Imigration_ratio=Immigration_num/Pop_num)
panelA
```

PanelA has `r nrow(panelA)` rows and `r ncol(panelA)`.

```{r}
panelA |> ggplot(aes(Imigration_ratio,Mean_income_FOR))+geom_point()
```

### PanelB

we only consider people aged between 18 and 64, which is regarded as labor age.

F:

```{r}
F = ilc_di16 |> filter(geo%in%countries,unit=='PPS',age=='Y18-64',
                       indic_il=='MEI_E',sex!='T')|>
  mutate(c_birth=case_when(c_birth %in% birth_eu ~ "EU_FOR",
    c_birth %in% birth_neu ~ "NEU_FOR",TRUE ~ c_birth ))|>
  filter(c_birth%in%c('EU_FOR','NEU_FOR')) |>
  mutate(Mean_income_FOR=values) |>
  select(sex,geo,c_birth,TIME_PERIOD,Mean_income_FOR)

```



```{r}
edat_lfs_9912|>filter(age=="Y18-64",geo%in%countries,) |>
  filter(isced11%in%c("ED0-2","ED3_4","ED5-8")) |>
  mutate(c_birth=case_when(c_birth %in% birth_eu ~ "EU_FOR",
    c_birth %in% birth_neu ~ "NEU_FOR",TRUE ~ c_birth ))|>
  filter(c_birth%in%c('EU_FOR','NEU_FOR')) |> 
  pivot_wider(names_from = isced11, values_from = values)
```

lfst_r_eredcobu,edat_lfs_9915
```{r}
edat_lfs_9912 |> distinct(isced11)
```




